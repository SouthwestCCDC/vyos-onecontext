name: CI

on:
  push:
    branches:
      - sagitta
  pull_request:
    branches:
      - sagitta

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run checks
        run: just check

  integration:
    # Integration tests require KVM - run on self-hosted runners
    # Only run on push to sagitta or PRs from the same repo (not forks)
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: [self-hosted, amd64, kvm]
    needs: check  # Only run if lint/unit tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git diff

      - name: Verify KVM access
        run: |
          if [ ! -e /dev/kvm ]; then
            echo "ERROR: /dev/kvm not available"
            exit 1
          fi
          echo "KVM is available"

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: |
          # Add HashiCorp APT repo for Packer
          curl -fsSL https://apt.releases.hashicorp.com/gpg -o /tmp/hashicorp.gpg
          sudo rm -f /usr/share/keyrings/hashicorp-archive-keyring.gpg
          sudo gpg --batch --yes --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg /tmp/hashicorp.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 genisoimage packer sshpass
          # Install Python dependencies for pytest integration tests
          uv sync --extra dev

      - name: Download base VyOS image
        run: |
          curl -fsSL -o vyos-base.qcow2 \
            https://artifacts.swccdc.com/iso/vyos-sagitta-base-5733700.qcow2
          echo "Downloaded base image:"
          ls -lh vyos-base.qcow2

      - name: Build test image with Packer
        working-directory: packer
        run: |
          packer init .
          packer build -var "base_image=${{ github.workspace }}/vyos-base.qcow2" .
        timeout-minutes: 10

      - name: Select fixtures to test
        id: select-fixtures
        run: |
          # Install PyYAML for fixture selection script
          sudo apt-get update && sudo apt-get install -y python3-yaml

          # Determine base ref for comparison
          if [ "${{ github.event_name }}" = "push" ]; then
            # On push to sagitta: always run all fixtures
            echo "EVENT: push to sagitta - running ALL fixtures"
            echo "fixtures=all" >> $GITHUB_OUTPUT
          else
            # On PR: run only affected fixtures
            echo "EVENT: pull request - selecting affected fixtures"
            BASE_REF="origin/${{ github.base_ref }}"

            # Run fixture selection script
            FIXTURES=$(python3 .github/scripts/select-fixtures.py "$BASE_REF" HEAD)

            if [ -z "$FIXTURES" ]; then
              echo "No fixtures selected (no relevant changes)"
              echo "fixtures=" >> $GITHUB_OUTPUT
            else
              echo "Selected fixtures: $FIXTURES"
              echo "fixtures=$FIXTURES" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run integration tests
        if: steps.select-fixtures.outputs.fixtures != ''
        run: |
          FIXTURES="${{ steps.select-fixtures.outputs.fixtures }}"

          if [ "$FIXTURES" = "all" ]; then
            echo "Running ALL integration test fixtures"
            ./tests/integration/run-all-tests.sh packer/output/vyos-onecontext-test.qcow2
          else
            echo "Running selected fixtures: $FIXTURES"
            # shellcheck disable=SC2086
            ./tests/integration/run-all-tests.sh packer/output/vyos-onecontext-test.qcow2 $FIXTURES
          fi
        timeout-minutes: 35
